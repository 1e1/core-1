#!/usr/bin/env bash
# Setups the repository.

# Stop on errors
set -e

cd "$(dirname "$0")/.."

mkdir -p config

cur_python=
# If a venv is active, get its version.
if [[ -n "${VIRTUAL_ENV}" ]]; then
    cur_python=$(python3 -V)
else
    # No venv active.
    # If a venv exists, activate it and get its version.
    for dir in venv .venv; do
        if [[ -e ${dir}/bin/activate ]]; then
            source ${dir}/bin/activate
            cur_python=$(python3 -V)
            break
        fi
    done
fi
# If a venv was active or found, check its version.
if [[ -n "${cur_python}" ]]; then
    ver_ok=false
    for ver in "3\.7" "3\.8"; do
        if [[ ${cur_python} =~ ^Python\ ${ver}[.0-9]*$ ]]; then
            ver_ok=true
            break
        fi
    done
    if ! $ver_ok; then
        echo $cur_python is not supported!
        exit 1
    fi
else
    # No venv active or found.
    # Create one and activate it.
    if [[ -x "$(command -v python3)" && "$(python3 -V)" =~ .*3\.[78].* ]]; then
        cmd=python3
    elif [[ -x "$(command -v python3.8)" ]]; then
        cmd="python3.8"
    elif [[ -x "$(command -v python3.7)" ]]; then
        cmd="python3.7"
    else
        echo Neither Python 3.7 nor 3.8 installed!
        exit 2
    fi
    $cmd -m venv venv
    source venv/bin/activate
fi

script/bootstrap

pre-commit install
python3 -m pip install -e . --constraint homeassistant/package_constraints.txt

hass --script ensure_config -c config

echo "
logger:
  default: info
  logs:
    homeassistant.components.cloud: debug
" >> config/configuration.yaml
